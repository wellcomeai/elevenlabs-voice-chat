<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Voice Chat - –ì–æ–ª–æ—Å–æ–≤–æ–µ –ü–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ v4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .header {
            margin-bottom: 2rem;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .status.disconnected {
            background: #fee;
            color: #c53030;
            border-left: 4px solid #c53030;
        }

        .status.connecting {
            background: #fef5e7;
            color: #d69e2e;
            border-left: 4px solid #d69e2e;
        }

        .status.connected {
            background: #f0fff4;
            color: #38a169;
            border-left: 4px solid #38a169;
        }

        .status.listening {
            background: #e6fffa;
            color: #319795;
            border-left: 4px solid #319795;
            animation: listening-pulse 2s infinite;
        }

        .status.speaking {
            background: #ebf8ff;
            color: #3182ce;
            border-left: 4px solid #3182ce;
            animation: pulse 1.5s infinite;
        }

        .status.recording {
            background: #fed7e2;
            color: #e53e3e;
            border-left: 4px solid #e53e3e;
            animation: recording-pulse 1s infinite;
        }

        .status.interrupted {
            background: #ffeaa7;
            color: #d63031;
            border-left: 4px solid #d63031;
            animation: interrupted-flash 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes listening-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        @keyframes recording-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }

        @keyframes interrupted-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .controls {
            margin: 2rem 0;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-interrupt {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            color: white;
            font-size: 0.9rem;
            padding: 0.8rem 1.5rem;
        }

        .btn-interrupt:disabled {
            background: #ccc;
        }

        .chat-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }

        .message {
            margin: 0.5rem 0;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: #e9ecef;
            color: #333;
            border-left: 3px solid #667eea;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            margin: 0 auto;
            font-style: italic;
        }

        .mic-animation {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            transition: all 0.3s ease;
        }

        .mic-animation.recording {
            animation: mic-recording 1.5s infinite;
            background: linear-gradient(45deg, #ff4757, #ff3742);
        }

        .mic-animation.listening {
            animation: mic-listening 2s infinite;
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }

        .mic-animation.interrupted {
            animation: mic-interrupted 0.5s infinite;
            background: linear-gradient(45deg, #ffa502, #ff6348);
        }

        .mic-animation.speaking {
            animation: mic-speaking 1s infinite;
            background: linear-gradient(45deg, #3182ce, #667eea);
        }

        @keyframes mic-recording {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes mic-listening {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes mic-interrupted {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.95); opacity: 0.6; }
        }

        @keyframes mic-speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .voice-interruption-indicator {
            margin: 1rem 0;
            padding: 0.75rem;
            border-radius: 8px;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            font-size: 0.9rem;
        }

        .voice-interruption-indicator.active {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
            animation: interruption-glow 1s infinite;
        }

        @keyframes interruption-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .connection-stats {
            margin: 0.5rem 0;
            font-size: 0.8rem;
            color: #666;
            text-align: left;
        }

        .interruption-stats {
            margin: 0.5rem 0;
            font-size: 0.75rem;
            color: #444;
            text-align: left;
            background: #f0f8ff;
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üé§ ElevenLabs –ì–æ–ª–æ—Å–æ–≤–æ–π –ß–∞—Ç v4.0</h1>
            <p class="subtitle">–ì–æ–ª–æ—Å–æ–≤–æ–µ –ü–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ ‚Ä¢ ElevenLabs Conversational AI</p>
        </div>

        <div id="status" class="status disconnected">
            üî¥ –û—Ç–∫–ª—é—á–µ–Ω
        </div>

        <div class="controls">
            <button id="connectBtn" class="btn btn-primary">
                üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            </button>
            <button id="disconnectBtn" class="btn btn-danger" disabled>
                ‚õî –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
            </button>
            <button id="interruptBtn" class="btn btn-interrupt" disabled>
                ‚ö° –ü—Ä–µ—Ä–≤–∞—Ç—å (—Ä—É—á–Ω–æ–µ)
            </button>
            <button id="diagnosticsBtn" class="btn btn-primary" style="background: linear-gradient(45deg, #2d3748, #4a5568);">
                üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            </button>
        </div>

        <div class="mic-animation" id="micAnimation">
            üé§
        </div>

        <div class="voice-interruption-indicator" id="voiceInterruptionIndicator">
            üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ: –ì–æ—Ç–æ–≤–æ ‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç–µ –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ—Ä–≤–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        </div>

        <div class="connection-stats" id="connectionStats">
            <div>–°—Ç–∞—Ç—É—Å: <span id="connectionState">–û—Ç–∫–ª—é—á–µ–Ω</span></div>
            <div>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: <span id="deviceType">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</span></div>
            <div>Conversation ID: <span id="conversationId">-</span></div>
        </div>

        <div class="interruption-stats" id="interruptionStats">
            <div><strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è:</strong></div>
            <div>–í—Å–µ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π: <span id="interruptionCount">0</span></div>
            <div>–ü–æ—Å–ª–µ–¥–Ω–µ–µ: <span id="lastInterruption">-</span></div>
            <div>–†–µ–∂–∏–º: <span id="interruptionMode">ElevenLabs VAD</span></div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="message system">
                –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
            </div>
        </div>

        <div class="footer">
            <p>üéØ –ì–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ ‚Ä¢ üéß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞</p>
            <p>Agent ID: <span id="agentId">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p>üé§ <strong>–ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ:</strong> –ü—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å –∫–æ–≥–¥–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç</p>
            <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #888;">
                üí° –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞–∂–º–∏—Ç–µ "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
            </p>
            <p style="margin-top: 0.25rem; font-size: 0.75rem; color: #999;">
                v4.0 ‚Ä¢ ElevenLabs Conversational AI ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ
            </p>
        </div>
    </div>

    <script>
        class ElevenLabsVoiceChat {
            constructor() {
                console.log('üöÄ ElevenLabs Voice Chat v4.0 —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ–º –∑–∞–ø—É—â–µ–Ω');
                
                // –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                this.ws = null;
                this.isConnected = false;
                this.isInitialized = false;
                this.agentId = null;
                this.conversationId = null;
                
                // –ê—É–¥–∏–æ —Å–∏—Å—Ç–µ–º–∞
                this.audioStream = null;
                this.isAgentSpeaking = false;
                this.isListening = false;
                
                // –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                this.interruptionState = {
                    count: 0,
                    lastTime: 0,
                    isEnabled: true,
                    mode: 'elevenlabs_vad' // ElevenLabs –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π VAD
                };
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                this.deviceInfo = this.getDeviceInfo();
                
                this.initializeElements();
                this.loadAgentConfig();
                
                console.log('‚úÖ ElevenLabs Voice Chat v4.0 —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            getDeviceInfo() {
                const userAgent = navigator.userAgent.toLowerCase();
                let deviceType = 'Desktop';
                
                if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                    deviceType = 'iOS';
                } else if (userAgent.includes('android')) {
                    deviceType = 'Android';
                } else if (userAgent.includes('mobile')) {
                    deviceType = 'Mobile';
                }
                
                return {
                    type: deviceType,
                    userAgent: navigator.userAgent
                };
            }

            initializeElements() {
                console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤');
                
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.interruptBtn = document.getElementById('interruptBtn');
                this.diagnosticsBtn = document.getElementById('diagnosticsBtn');
                this.status = document.getElementById('status');
                this.chatArea = document.getElementById('chatArea');
                this.micAnimation = document.getElementById('micAnimation');
                this.agentIdSpan = document.getElementById('agentId');
                this.connectionStateSpan = document.getElementById('connectionState');
                this.conversationIdSpan = document.getElementById('conversationId');
                this.deviceTypeSpan = document.getElementById('deviceType');
                this.voiceInterruptionIndicator = document.getElementById('voiceInterruptionIndicator');
                this.interruptionCountSpan = document.getElementById('interruptionCount');
                this.lastInterruptionSpan = document.getElementById('lastInterruption');
                this.interruptionModeSpan = document.getElementById('interruptionMode');

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                if (this.deviceTypeSpan) {
                    this.deviceTypeSpan.textContent = this.deviceInfo.type;
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                if (this.connectBtn) {
                    this.connectBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Connect button clicked');
                        this.connect();
                    });
                }
                
                if (this.disconnectBtn) {
                    this.disconnectBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Disconnect button clicked');
                        this.disconnect();
                    });
                }
                
                if (this.diagnosticsBtn) {
                    this.diagnosticsBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Diagnostics button clicked');
                        this.runDiagnostics();
                    });
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                if (this.interruptBtn) {
                    this.interruptBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Manual interrupt button clicked');
                        this.manualInterrupt();
                    });
                }

                console.log('‚úÖ UI —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
            }

            async runDiagnostics() {
                this.addMessage('system', 'üîç –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è...');
                this.diagnosticsBtn.disabled = true;
                this.diagnosticsBtn.innerHTML = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                
                try {
                    console.log('üîç Running diagnostics');
                    const response = await fetch('/api/diagnostics');
                    const data = await response.json();
                    
                    console.log('Diagnostics results:', data);
                    
                    this.addMessage('system', 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:');
                    
                    if (data.tests) {
                        Object.entries(data.tests).forEach(([test, result]) => {
                            const icon = result === 'passed' ? '‚úÖ' : result === 'failed' ? '‚ùå' : '‚ö†Ô∏è';
                            const testName = test.replace(/_/g, ' ');
                            this.addMessage('system', `${icon} ${testName}: ${result}`);
                        });
                    }
                    
                    if (data.overall) {
                        const overallIcon = data.overall.status === 'healthy' ? 'üü¢' : 
                                           data.overall.status === 'partial' ? 'üü°' : 'üî¥';
                        this.addMessage('system', `${overallIcon} –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å: ${data.overall.status} (${data.overall.health_score})`);
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ–ª–æ—Å–æ–≤–æ–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–∏
                    if (data.voice_interruption_system) {
                        this.addMessage('system', `üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ: ${data.voice_interruption_system.status}`);
                        this.addMessage('system', `üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${this.deviceInfo.type}`);
                        
                        const deviceOpt = data.voice_interruption_system.device_optimizations[this.deviceInfo.type.toLowerCase()];
                        if (deviceOpt) {
                            this.addMessage('system', `‚öôÔ∏è –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è: ${deviceOpt.threshold}, –†–µ–∂–∏–º: ${deviceOpt.expected_behavior}`);
                        }
                    }
                    
                    if (data.recommendations && data.recommendations.length > 0) {
                        this.addMessage('system', 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:');
                        data.recommendations.forEach(rec => {
                            this.addMessage('system', rec);
                        });
                    }
                    
                } catch (error) {
                    console.error('Diagnostics failed:', error);
                    this.addMessage('system', '‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + error.message);
                } finally {
                    this.diagnosticsBtn.disabled = false;
                    this.diagnosticsBtn.innerHTML = 'üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞';
                }
            }

            async loadAgentConfig() {
                try {
                    console.log('üì° Loading agent config');
                    this.addMessage('system', 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞...');
                    
                    const response = await fetch('/api/agent-id');
                    const data = await response.json();
                    
                    console.log('Agent config response:', data);
                    
                    if (data.agent_id && data.status === 'ready') {
                        this.agentId = data.agent_id;
                        if (this.agentIdSpan) {
                            this.agentIdSpan.textContent = this.agentId.substring(0, 12) + '...';
                        }
                        this.addMessage('system', `‚úÖ –ê–≥–µ–Ω—Ç –≥–æ—Ç–æ–≤ (ID: ${this.agentId.substring(0, 8)}...)`);
                        this.addMessage('system', 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
                        this.addMessage('system', `üì± –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è ${this.deviceInfo.type}`);
                        
                        if (this.connectBtn) {
                            this.connectBtn.disabled = false;
                            this.connectBtn.innerHTML = 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                        }
                    } else {
                        throw new Error(data.details || 'Agent not ready');
                    }
                } catch (error) {
                    console.error('Failed to load agent config:', error);
                    this.addMessage('system', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–∞: ${error.message}`);
                    if (this.agentIdSpan) {
                        this.agentIdSpan.textContent = '–û—à–∏–±–∫–∞';
                    }
                    if (this.connectBtn) {
                        this.connectBtn.disabled = true;
                        this.connectBtn.innerHTML = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    }
                    
                    setTimeout(() => {
                        this.loadAgentConfig();
                    }, 10000);
                }
            }

            async connect() {
                if (!this.agentId) {
                    this.addMessage('system', '‚ùå –ê–≥–µ–Ω—Ç –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
                    return;
                }

                try {
                    console.log('üöÄ Starting connection process');
                    this.updateStatus('connecting', 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                    this.connectionStateSpan.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                    this.addMessage('system', 'üé§ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                    this.audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    console.log('‚úÖ Microphone access granted');

                    this.addMessage('system', 'üîê –ü–æ–ª—É—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ URL...');
                    
                    let wsUrl;
                    let connectionMethod = 'unknown';
                    
                    try {
                        const signedUrlResponse = await fetch('/api/signed-url');
                        const signedData = await signedUrlResponse.json();
                        
                        console.log('Signed URL response:', signedData);
                        
                        if (signedUrlResponse.ok && signedData.signed_url) {
                            wsUrl = signedData.signed_url;
                            connectionMethod = 'signed';
                            console.log('‚úÖ Using signed URL for WebSocket connection');
                            this.addMessage('system', '‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π URL –ø–æ–ª—É—á–µ–Ω');
                        } else {
                            wsUrl = signedData.fallback_url || `wss://api.elevenlabs.io/v1/convai/conversation?agent_id=${this.agentId}`;
                            connectionMethod = 'fallback';
                            console.log('‚ö†Ô∏è Using fallback direct URL');
                            this.addMessage('system', '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                            
                            if (signedData.error) {
                                this.addMessage('system', `–ü—Ä–∏—á–∏–Ω–∞: ${signedData.error}`);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to get signed URL:', error);
                        wsUrl = `wss://api.elevenlabs.io/v1/convai/conversation?agent_id=${this.agentId}`;
                        connectionMethod = 'direct';
                        this.addMessage('system', '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                        this.addMessage('system', `–û—à–∏–±–∫–∞ URL: ${error.message}`);
                    }

                    console.log('üîó Connecting to ElevenLabs WebSocket:', wsUrl);
                    this.addMessage('system', `üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∞–≥–µ–Ω—Ç—É (${connectionMethod})...`);
                    
                    // –°–æ–∑–¥–∞–µ–º WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ElevenLabs
                    this.ws = new WebSocket(wsUrl);
                    
                    const connectionTimeout = setTimeout(() => {
                        if (this.ws && this.ws.readyState === WebSocket.CONNECTING) {
                            console.log('Connection timeout (10s)');
                            this.addMessage('system', '‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (10 —Å–µ–∫)');
                            this.ws.close();
                        }
                    }, 10000);

                    this.ws.onopen = () => {
                        clearTimeout(connectionTimeout);
                        this.onWebSocketOpen();
                    };
                    
                    this.ws.onmessage = (event) => this.onWebSocketMessage(event);
                    
                    this.ws.onclose = (event) => {
                        clearTimeout(connectionTimeout);
                        this.onWebSocketClose(event);
                    };
                    
                    this.ws.onerror = (error) => {
                        clearTimeout(connectionTimeout);
                        console.error('WebSocket error:', error);
                        this.onWebSocketError(error, connectionMethod);
                    };

                } catch (error) {
                    console.error('Connection failed:', error);
                    
                    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ';
                    if (error.name === 'NotAllowedError') {
                        errorMessage += '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.';
                        this.addMessage('system', 'üí° –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
                        this.addMessage('system', 'üí° –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                        this.addMessage('system', 'üí° –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω');
                    } else {
                        errorMessage += error.message;
                    }
                    
                    this.addMessage('system', errorMessage);
                    this.updateStatus('disconnected', 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω');
                    this.connectionStateSpan.textContent = '–û—à–∏–±–∫–∞';
                }
            }

            onWebSocketOpen() {
                console.log('‚úÖ ElevenLabs WebSocket connected');
                this.isConnected = true;
                this.updateStatus('connecting', 'üü° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
                this.connectionStateSpan.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                this.addMessage('system', 'üîó WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ ElevenLabs');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                this.sendInitializationMessage();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
                this.interruptionState.count = 0;
                this.interruptionState.lastTime = 0;
                this.updateInterruptionStats();
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                this.connectBtn.disabled = true;
                this.disconnectBtn.disabled = false;
                this.interruptBtn.disabled = false;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                this.voiceInterruptionIndicator.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç–µ –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ—Ä–≤–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞';
                this.voiceInterruptionIndicator.classList.remove('active');
                
                console.log(`‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è ${this.deviceInfo.type}`);
            }

            sendInitializationMessage() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    // ElevenLabs –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
                    const initMessage = {
                        type: "conversation_initiation_client_data",
                        conversation_initiation_client_data: {
                            custom_llm_extra_body: {}
                        }
                    };
                    
                    console.log('üì§ Sending initialization message to ElevenLabs:', initMessage);
                    this.ws.send(JSON.stringify(initMessage));
                }
            }

            onWebSocketMessage(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì• Received from ElevenLabs:', data.type, data);

                    const messageType = data.type;

                    switch (messageType) {
                        case 'conversation_initiation_metadata':
                            this.handleConversationInitiation(data);
                            break;
                            
                        case 'user_transcript':
                        case 'user_transcription':
                            this.handleUserTranscript(data);
                            break;
                            
                        case 'agent_response':
                            this.handleAgentResponse(data);
                            break;
                            
                        case 'agent_response_correction':
                            this.handleAgentResponseCorrection(data);
                            break;
                            
                        case 'audio':
                            this.handleAudioResponse(data);
                            break;
                            
                        case 'interruption':
                            // üé§ –ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –æ—Ç ElevenLabs
                            this.handleVoiceInterruption(data);
                            break;
                            
                        case 'ping':
                            this.handlePing(data);
                            break;
                            
                        case 'pong':
                            this.handlePong(data);
                            break;
                            
                        case 'error':
                            this.handleServerError(data);
                            break;
                            
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
                        case 'internal_vad':
                        case 'vad_score':
                            console.log('üé§ VAD from ElevenLabs:', data);
                            break;
                            
                        case 'user_speech_started':
                            console.log('üó£Ô∏è User speech started (ElevenLabs VAD)');
                            // –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ
                            if (this.isAgentSpeaking) {
                                console.log('‚ö° Voice interruption detected by ElevenLabs VAD!');
                                this.handleVoiceInterruption({ 
                                    type: "interruption", 
                                    source: "elevenlabs_vad",
                                    trigger: "user_speech_started"
                                });
                            }
                            break;
                            
                        case 'user_speech_stopped':
                            console.log('üîá User speech stopped (ElevenLabs VAD)');
                            break;
                            
                        default:
                            console.log('Unknown message type from ElevenLabs:', messageType, data);
                    }
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                    console.error('Raw message:', event.data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    if (typeof event.data !== 'string') {
                        console.log('Received binary data, length:', event.data.length || event.data.byteLength || 'unknown');
                    }
                }
            }

            handleConversationInitiation(data) {
                const metadata = data.conversation_initiation_metadata_event;
                console.log('‚úÖ ElevenLabs conversation initiated:', metadata);
                
                this.isInitialized = true;
                this.conversationId = metadata.conversation_id;
                
                if (this.conversationIdSpan) {
                    this.conversationIdSpan.textContent = metadata.conversation_id.substring(0, 8) + '...';
                }
                
                this.updateStatus('listening', 'üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≥–æ–≤–æ—Ä—É');
                this.connectionStateSpan.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                
                this.addMessage('system', `‚úÖ –†–∞–∑–≥–æ–≤–æ—Ä –Ω–∞—á–∞—Ç (ID: ${metadata.conversation_id.substring(0, 8)}...)`);
                this.addMessage('system', 'üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ... –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Å–ª—É—à–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ');
                this.addMessage('system', '‚ö° –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
                
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ
                this.startContinuousAudioCapture();
            }

            handleUserTranscript(data) {
                // ElevenLabs –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                let transcript = '';
                
                if (data.user_transcription_event) {
                    transcript = data.user_transcription_event.user_transcript;
                } else if (data.user_transcript_event) {
                    transcript = data.user_transcript_event.user_transcript;
                } else if (data.transcript) {
                    transcript = data.transcript;
                } else if (data.user_transcript) {
                    transcript = data.user_transcript;
                }
                
                if (transcript && transcript.trim()) {
                    console.log('üë§ User transcript:', transcript);
                    this.addMessage('user', transcript);
                } else {
                    console.log('üë§ Empty or invalid user transcript:', data);
                }
            }

            handleAgentResponse(data) {
                // ElevenLabs –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                let response = '';
                
                if (data.agent_response_event) {
                    response = data.agent_response_event.agent_response;
                } else if (data.agent_response) {
                    response = data.agent_response;
                } else if (data.response) {
                    response = data.response;
                } else if (data.message) {
                    response = data.message;
                }
                
                if (response && response.trim()) {
                    console.log('ü§ñ Agent response:', response);
                    this.addMessage('assistant', response);
                    
                    // –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞—á–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å
                    this.setAgentSpeaking(true);
                } else {
                    console.log('ü§ñ Empty or invalid agent response:', data);
                }
            }

            handleAgentResponseCorrection(data) {
                const correction = data.agent_response_correction_event;
                console.log('üìù Agent response correction:', correction);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                const messages = this.chatArea.querySelectorAll('.message.assistant');
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    lastMessage.textContent = correction.corrected_agent_response;
                }
            }

            handleAudioResponse(data) {
                try {
                    // ElevenLabs –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ audio_event
                    const audioBase64 = data.audio_event ? data.audio_event.audio_base_64 : data.audio_base_64;
                    
                    if (!audioBase64) {
                        console.warn('No audio data in response:', data);
                        return;
                    }
                    
                    console.log('üîä Received audio from ElevenLabs agent, length:', audioBase64.length);
                    
                    // –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç
                    this.setAgentSpeaking(true);
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
                    this.playAudio(audioBase64);
                    
                } catch (error) {
                    console.error('Error handling audio response:', error);
                }
            }

            // üé§ –ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
            handleVoiceInterruption(data) {
                console.log('‚ö° –ì–û–õ–û–°–û–í–û–ï –ü–ï–†–ï–ë–ò–í–ê–ù–ò–ï –æ—Ç ElevenLabs:', data);
                
                this.interruptionState.count++;
                this.interruptionState.lastTime = Date.now();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                this.setAgentSpeaking(false);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateStatus('interrupted', `‚ö†Ô∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ #${this.interruptionState.count}`);
                this.micAnimation.classList.remove('speaking', 'listening');
                this.micAnimation.classList.add('interrupted');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ
                this.voiceInterruptionIndicator.textContent = `‚ö° –ü–ï–†–ï–ë–ò–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û #${this.interruptionState.count} ‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å`;
                this.voiceInterruptionIndicator.classList.add('active');
                
                this.addMessage('system', `‚ö° –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ #${this.interruptionState.count} ‚Ä¢ ElevenLabs VAD`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.updateInterruptionStats();
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
                setTimeout(() => {
                    if (!this.isAgentSpeaking) {
                        this.resumeListening();
                    }
                }, 500);
            }

            handlePing(data) {
                // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ ping –æ—Ç ElevenLabs
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: "pong" }));
                    console.log('üèì Pong sent to ElevenLabs');
                }
            }

            handlePong(data) {
                console.log('üèì Pong received from ElevenLabs');
            }

            handleServerError(data) {
                console.error('‚ùå ElevenLabs server error:', data);
                
                let errorMsg = 'Unknown server error';
                let errorCode = 'unknown';
                
                if (data.error) {
                    if (typeof data.error === 'string') {
                        errorMsg = data.error;
                    } else if (data.error.message) {
                        errorMsg = data.error.message;
                        errorCode = data.error.code || 'unknown';
                    }
                } else if (data.message) {
                    errorMsg = data.message;
                }
                
                this.addMessage('system', `‚ùå –û—à–∏–±–∫–∞ ElevenLabs: ${errorMsg}`);
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
                if (errorMsg.includes('audio') || errorMsg.includes('format')) {
                    this.addMessage('system', 'üí° –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –∞—É–¥–∏–æ');
                    this.addMessage('system', '‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    this.addMessage('system', '‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
                } else if (errorMsg.includes('quota') || errorMsg.includes('limit')) {
                    this.addMessage('system', 'üí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API');
                } else if (errorMsg.includes('auth') || errorMsg.includes('key')) {
                    this.addMessage('system', 'üí° –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏–ª–∏ API –∫–ª—é—á–æ–º');
                }
                
                if (data.critical || data.fatal || errorCode === 'fatal') {
                    this.addMessage('system', 'üí• –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ...');
                    setTimeout(() => {
                        this.disconnect();
                    }, 2000);
                }
            }

            setAgentSpeaking(speaking) {
                this.isAgentSpeaking = speaking;
                
                if (speaking) {
                    console.log('üó£Ô∏è Agent started speaking');
                    this.updateStatus('speaking', 'üéØ –ò–ò –≥–æ–≤–æ—Ä–∏—Ç...');
                    this.micAnimation.classList.remove('recording', 'listening', 'interrupted');
                    this.micAnimation.classList.add('speaking');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                    this.voiceInterruptionIndicator.textContent = 'üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–µ—Ä–≤–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ‚Ä¢ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
                    this.voiceInterruptionIndicator.classList.remove('active');
                    
                } else {
                    console.log('üîá Agent stopped speaking');
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é
                    setTimeout(() => {
                        this.resumeListening();
                    }, 300);
                }
            }

            resumeListening() {
                if (this.isConnected && this.isInitialized && !this.isAgentSpeaking) {
                    console.log('üé§ Resumed listening for voice interruption');
                    this.updateStatus('listening', 'üü¢ –°–ª—É—à–∞—é...');
                    this.micAnimation.classList.remove('recording', 'speaking', 'interrupted');
                    this.micAnimation.classList.add('listening');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                    this.voiceInterruptionIndicator.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ ‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ';
                    this.voiceInterruptionIndicator.classList.remove('active');
                }
            }

            async startContinuousAudioCapture() {
                if (!this.audioStream) return;

                try {
                    console.log('üé§ Starting continuous audio capture for ElevenLabs...');
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è ElevenLabs
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });
                    
                    const source = audioContext.createMediaStreamSource(this.audioStream);
                    const processor = audioContext.createScriptProcessor(1024, 1, 1); // –ú–µ–Ω—å—à–∏–π –±—É—Ñ–µ—Ä
                    
                    let isProcessing = false;
                    let audioBuffer = [];
                    
                    processor.onaudioprocess = (event) => {
                        if (this.ws && this.ws.readyState === WebSocket.OPEN && this.isInitialized && !isProcessing) {
                            const inputBuffer = event.inputBuffer;
                            const channelData = inputBuffer.getChannelData(0);
                            
                            // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ
                            audioBuffer.push(new Float32Array(channelData));
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 100–º—Å (1600 —Å–µ–º–ø–ª–æ–≤ –ø—Ä–∏ 16kHz)
                            if (audioBuffer.length >= 2) { // –ø—Ä–∏–º–µ—Ä–Ω–æ 128–º—Å
                                isProcessing = true;
                                
                                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –±—É—Ñ–µ—Ä—ã
                                const totalLength = audioBuffer.reduce((sum, arr) => sum + arr.length, 0);
                                const combinedBuffer = new Float32Array(totalLength);
                                let offset = 0;
                                
                                audioBuffer.forEach(arr => {
                                    combinedBuffer.set(arr, offset);
                                    offset += arr.length;
                                });
                                
                                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ PCM16 –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                                const pcmData = this.convertToPCM16(combinedBuffer);
                                const base64Audio = this.arrayBufferToBase64(pcmData);
                                
                                // ElevenLabs –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                                const audioMessage = {
                                    user_audio_chunk: base64Audio
                                };
                                
                                try {
                                    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                                    if (base64Audio.length === 0) {
                                        console.warn('Empty audio data, skipping send');
                                        audioBuffer = [];
                                        isProcessing = false;
                                        return;
                                    }
                                    
                                    if (base64Audio.length > 100000) {
                                        console.warn('Very large audio chunk:', base64Audio.length, 'chars');
                                    }
                                    
                                    this.ws.send(JSON.stringify(audioMessage));
                                    
                                    // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Å–æ–ª—å
                                    if (Math.random() < 0.01) { // 1% —Å–æ–æ–±—â–µ–Ω–∏–π
                                        console.log('üì§ Sent audio chunk to ElevenLabs, size:', base64Audio.length, 'chars');
                                    }
                                } catch (error) {
                                    console.error('Error sending audio to ElevenLabs:', error);
                                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                                    if (error.message.includes('WebSocket') || this.ws.readyState !== WebSocket.OPEN) {
                                        console.warn('WebSocket connection lost, will attempt to reconnect');
                                        this.addMessage('system', '‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è');
                                    }
                                }
                                
                                // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
                                audioBuffer = [];
                                isProcessing = false;
                            }
                        }
                    };
                    
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    this.audioContext = audioContext;
                    this.audioProcessor = processor;
                    this.audioSource = source;
                    
                    this.micAnimation.classList.add('listening');
                    console.log('‚úÖ Continuous audio capture started for ElevenLabs');
                    
                } catch (error) {
                    console.error('‚ùå Failed to start audio capture:', error);
                    this.addMessage('system', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ: ${error.message}`);
                }
            }

            convertToPCM16(float32Array) {
                const buffer = new ArrayBuffer(float32Array.length * 2);
                const view = new DataView(buffer);
                
                for (let i = 0; i < float32Array.length; i++) {
                    let sample = Math.max(-1, Math.min(1, float32Array[i]));
                    const pcmSample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(i * 2, pcmSample, true);
                }
                
                return new Uint8Array(buffer);
            }

            arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                
                return btoa(binary);
            }

            playAudio(audioBase64) {
                try {
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –∞—É–¥–∏–æ –æ—Ç ElevenLabs
                    const audioData = atob(audioBase64);
                    const pcmArray = new Uint8Array(audioData.length);
                    
                    for (let i = 0; i < audioData.length; i++) {
                        pcmArray[i] = audioData.charCodeAt(i);
                    }

                    // –°–æ–∑–¥–∞–µ–º WAV blob –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
                    const wavBlob = this.createWavBlob(pcmArray, 16000, 1, 16);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.volume = 0.8;
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–æ–≤–æ—Ä–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                        setTimeout(() => {
                            if (this.isAgentSpeaking) {
                                this.setAgentSpeaking(false);
                            }
                        }, 100);
                    };
                    
                    audio.onerror = (error) => {
                        console.error('Audio playback error:', error);
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.play().catch(error => {
                        console.error('Failed to play audio:', error);
                        URL.revokeObjectURL(audioUrl);
                    });
                    
                } catch (error) {
                    console.error('Error playing audio:', error);
                }
            }

            createWavBlob(pcmArray, sampleRate, numChannels, bitsPerSample) {
                const length = pcmArray.length;
                const arrayBuffer = new ArrayBuffer(44 + length);
                const view = new DataView(arrayBuffer);
                
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + length, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true);
                view.setUint16(32, numChannels * (bitsPerSample / 8), true);
                view.setUint16(34, bitsPerSample, true);
                writeString(36, 'data');
                view.setUint32(40, length, true);
                
                for (let i = 0; i < length; i++) {
                    view.setUint8(44 + i, pcmArray[i]);
                }
                
                return new Blob([arrayBuffer], { type: 'audio/wav' });
            }

            manualInterrupt() {
                if (this.isAgentSpeaking && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    console.log('‚ö° Manual interrupt triggered');
                    
                    // –î–ª—è ElevenLabs –º–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                    // –ù–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ VAD —Å–∏—Å—Ç–µ–º—É ElevenLabs
                    
                    // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ
                    this.handleVoiceInterruption({ 
                        type: "interruption",
                        source: "manual",
                        timestamp: Date.now()
                    });
                    
                    // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    // —á—Ç–æ–±—ã "—Ä–∞–∑–±—É–¥–∏—Ç—å" VAD —Å–∏—Å—Ç–µ–º—É ElevenLabs
                    try {
                        const silenceBuffer = new ArrayBuffer(1024); // –ö–æ—Ä–æ—Ç–∫–∏–π –±—É—Ñ–µ—Ä —Ç–∏—à–∏–Ω—ã
                        const base64Silence = this.arrayBufferToBase64(new Uint8Array(silenceBuffer));
                        
                        this.ws.send(JSON.stringify({
                            user_audio_chunk: base64Silence
                        }));
                        
                        console.log('üì§ Sent silence audio to trigger ElevenLabs VAD');
                    } catch (error) {
                        console.error('Error sending manual interrupt:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è Cannot interrupt: agent not speaking or connection lost');
                }
            }

            updateInterruptionStats() {
                if (this.interruptionCountSpan) {
                    this.interruptionCountSpan.textContent = this.interruptionState.count;
                }
                
                if (this.lastInterruptionSpan && this.interruptionState.lastTime > 0) {
                    const lastTime = new Date(this.interruptionState.lastTime);
                    this.lastInterruptionSpan.textContent = lastTime.toLocaleTimeString();
                }
                
                if (this.interruptionModeSpan) {
                    this.interruptionModeSpan.textContent = 'ElevenLabs VAD';
                }
            }

            stopAudioCapture() {
                console.log('üõë Stopping audio capture...');
                
                if (this.audioProcessor) {
                    this.audioProcessor.disconnect();
                    this.audioProcessor = null;
                }
                
                if (this.audioSource) {
                    this.audioSource.disconnect();
                    this.audioSource = null;
                }
                
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close().then(() => {
                        console.log('üìä AudioContext closed');
                    }).catch(error => {
                        console.error('Error closing AudioContext:', error);
                    });
                    this.audioContext = null;
                }
                
                this.micAnimation.classList.remove('recording', 'listening', 'interrupted', 'speaking');
                console.log('‚úÖ Audio capture stopped');
            }

            disconnect() {
                console.log('üîå Disconnecting from ElevenLabs...');
                
                if (this.ws) {
                    if (this.ws.readyState === WebSocket.OPEN) {
                        try {
                            this.ws.send(JSON.stringify({ type: "end_of_stream" }));
                        } catch (error) {
                            console.log('Failed to send end_of_stream:', error);
                        }
                    }
                    this.ws.close(1000, 'Normal closure');
                }
                
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }

                this.stopAudioCapture();

                this.isConnected = false;
                this.isInitialized = false;
                this.isAgentSpeaking = false;
                this.conversationId = null;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π
                this.interruptionState.count = 0;
                this.interruptionState.lastTime = 0;
                this.updateInterruptionStats();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.connectBtn.disabled = false;
                this.disconnectBtn.disabled = true;
                this.interruptBtn.disabled = true;
                
                if (this.connectionStateSpan) {
                    this.connectionStateSpan.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
                }
                
                if (this.conversationIdSpan) {
                    this.conversationIdSpan.textContent = '-';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è
                this.voiceInterruptionIndicator.textContent = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ: –û—Ç–∫–ª—é—á–µ–Ω–æ ‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏';
                this.voiceInterruptionIndicator.classList.remove('active');
            }

            onWebSocketClose(event) {
                const code = event?.code || 'unknown';
                const reason = event?.reason || 'unknown';
                
                console.log('‚ùå ElevenLabs WebSocket disconnected. Code:', code, 'Reason:', reason);
                console.log('Full close event:', event);
                
                this.isConnected = false;
                this.isAgentSpeaking = false;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.connectBtn.disabled = false;
                this.disconnectBtn.disabled = true;
                this.interruptBtn.disabled = true;
                this.connectionStateSpan.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
                this.micAnimation.classList.remove('recording', 'listening', 'interrupted', 'speaking');

                let statusMessage = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω';
                let systemMessage = 'üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ElevenLabs –∑–∞–∫—Ä—ã—Ç–æ';
                
                if (code === 1000) {
                    systemMessage = '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ';
                } else if (code === 1006) {
                    systemMessage = '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ (–∫–æ–¥ 1006)';
                    statusMessage = 'üî¥ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                } else if (code === 1008) {
                    systemMessage = '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–æ–¥ 1008)';
                    systemMessage += ' - –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö';
                    statusMessage = 'üî¥ –û—à–∏–±–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞';
                } else if (code === 1011) {
                    systemMessage = '‚ùå –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ElevenLabs (–∫–æ–¥ 1011)';
                    statusMessage = 'üî¥ –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                } else if (code !== 1000 && code !== 'unknown') {
                    systemMessage = `‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å –∫–æ–¥–æ–º: ${code}`;
                    if (reason && reason !== 'unknown') {
                        systemMessage += ` (${reason})`;
                    }
                    statusMessage = 'üî¥ –û—à–∏–±–∫–∞';
                }
                
                this.updateStatus('disconnected', statusMessage);
                this.addMessage('system', systemMessage);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–∫–∏ 1008
                if (code === 1008) {
                    this.addMessage('system', 'üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:');
                    this.addMessage('system', '‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    this.addMessage('system', '‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
                    this.addMessage('system', '‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä');
                }

                this.stopAudioCapture();
            }

            onWebSocketError(error, connectionMethod = 'unknown') {
                console.error('‚ùå ElevenLabs WebSocket error:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ElevenLabs';
                let recommendations = [];
                
                if (connectionMethod === 'signed') {
                    errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                    recommendations.push('‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ signed URL');
                } else if (connectionMethod === 'fallback' || connectionMethod === 'direct') {
                    errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                    recommendations.push('‚Ä¢ –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω');
                } else {
                    recommendations.push('‚Ä¢ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                }
                
                this.addMessage('system', errorMessage);
                recommendations.forEach(rec => {
                    this.addMessage('system', rec);
                });
                
                this.updateStatus('disconnected', 'üî¥ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                this.connectionStateSpan.textContent = '–û—à–∏–±–∫–∞';
                this.connectBtn.disabled = false;
                this.disconnectBtn.disabled = true;
                this.interruptBtn.disabled = true;
            }

            updateStatus(className, text) {
                if (this.status) {
                    this.status.className = `status ${className}`;
                    this.status.textContent = text;
                }
            }

            addMessage(type, content) {
                if (this.chatArea) {
                    const message = document.createElement('div');
                    message.className = `message ${type}`;
                    message.textContent = content;
                    
                    this.chatArea.appendChild(message);
                    this.chatArea.scrollTop = this.chatArea.scrollHeight;
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, initializing ElevenLabs Voice Chat v4.0...');
            try {
                window.elevenLabsVoiceChat = new ElevenLabsVoiceChat();
                console.log('‚úÖ ElevenLabs Voice Chat v4.0 —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                console.error('‚ùå Failed to initialize ElevenLabs Voice Chat:', error);
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            console.error('üö® Global JavaScript Error:', event.error);
            console.error('üö® Error details:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });
    </script>
</body>
</html>
